<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุชุทุจูู ูุชููู ุงูุนุฑุจูุฉ (ุจุฏูู ุจุงู-ุฅูุฏ)</title>

  <!-- External stylesheet -->
  <link rel="stylesheet" href="styles.css" />

  <!-- Small, safe fallback styles in case styles.css is missing -->
  <style>
    body { margin: 0; }
    img { max-width: 100%; height: auto; }
    label { display:block; margin-bottom: 6px; }
    select, textarea, input, button { width: 100%; }
  </style>
</head>

<body>
  <div class="app beginner-mode">
    <div class="rows-container">
      <!-- Header with logo -->
      <header class="header">
        <div class="title-block">
          <img src="logo.svg" alt="Logo" class="site-logo animated-logo" />
          <div>
            <h1>๐ฃ๏ธ ุชุทุจูู ูุชููู ุงูุนุฑุจูุฉ</h1>
            <div class="subtitle">ูููู ุฏุงุฎู ุงููุชุตูุญ โ ุจุฏูู ุจุงู-ุฅูุฏ</div>
          </div>
        </div>

        <div class="chip" title="ุญุงูุฉ ุงูุชุทุจูู">
          <span class="chip-dot"></span>
          Ready
        </div>
      </header>

      <div class="tab-pages">
        <section class="tab-page active">
          <div class="row row-top">
            <div class="col-left">
              <div class="card">
                <div class="card-header">
                  <div>
                    <div class="card-title"><span class="icon">๐</span> ุงููุต</div>
                    <div class="card-subtitle">ุงูุชุจ ุงููุต ุฃู ุงุณุชุฎุฏู ุงูุงุณุชูุงุน ูุฅููุงุฆู</div>
                  </div>
                  <div class="status-pill connected">
                    <span class="status-dot"></span>
                    TTS: <span id="ttsStatus" class="mono">ุฌุงูุฒ</span>
                  </div>
                </div>

                <label for="text">ุงููุต ุงูุฐู ุชุฑูุฏ ุฃู ููุทูู ุงูุชุทุจูู:</label>
                <textarea id="text" placeholder="ุงูุชุจ ููุง...">ูุฑุญุจุงู! ุฃูุง ุชุทุจูู ูุนูู ุจุฏูู ุจุงู-ุฅูุฏ ูุฃุชููู ุงูุนุฑุจูุฉ.</textarea>

                <div class="hint">
                  <div class="hint-title">ููุงุญุธุฉ</div>
                  <ol>
                    <li>ููุฒุฉ ุงูุงุณุชูุงุน ุชุนูู ุบุงูุจุงู ูู Chrome/Edge ูุชุญุชุงุฌ HTTPS ุฃู localhost.</li>
                    <li>ุงูุฃุตูุงุช ุงูุนุฑุจูุฉ ุงููุชุงุญุฉ ุชุฎุชูู ุญุณุจ ูุธุงู ุงูุชุดุบูู ูุงููุชุตูุญ.</li>
                  </ol>
                </div>
              </div>

              <div class="card">
                <div class="card-header">
                  <div class="card-title"><span class="icon">๐๏ธ</span> ุงูุฅุนุฏุงุฏุงุช</div>
                  <div class="status-pill">
                    <span class="status-dot"></span>
                    STT: <span id="sttStatus" class="mono">ุบูุฑ ูุดุท</span>
                  </div>
                </div>

                <div class="controls-grid">
                  <div class="control-section">
                    <div class="section-header">
                      <div class="section-title"><span class="section-icon">๐ฃ๏ธ</span> ุงูุตูุช (Voice)</div>
                      <div class="section-subtitle">ุงุฎุชุฑ ุงูุตูุช ุงููุชุงุญ ุนูู ุฌูุงุฒู</div>
                    </div>
                    <select id="voice"></select>
                  </div>

                  <div class="control-section">
                    <div class="section-header">
                      <div class="section-title"><span class="section-icon">๐๏ธ</span> ููุฌุฉ ุงูุชุนุฑูู ุนูู ุงูููุงู</div>
                      <div class="section-subtitle">ุชุคุซุฑ ุนูู ุฏููุฉ ุงูุชุญููู ูู ููุงู ุฅูู ูุต</div>
                    </div>
                    <select id="dialect">
                      <option value="ar-SA">ar-SA (ุงูุณุนูุฏูุฉ)</option>
                      <option value="ar-EG">ar-EG (ูุตุฑ)</option>
                      <option value="ar-AE">ar-AE (ุงูุฅูุงุฑุงุช)</option>
                      <option value="ar-JO">ar-JO (ุงูุฃุฑุฏู)</option>
                      <option value="ar-LB">ar-LB (ูุจูุงู)</option>
                      <option value="ar-MA">ar-MA (ุงููุบุฑุจ)</option>
                      <option value="ar-DZ">ar-DZ (ุงูุฌุฒุงุฆุฑ)</option>
                      <option value="ar-TN">ar-TN (ุชููุณ)</option>
                      <option value="ar-IQ">ar-IQ (ุงูุนุฑุงู)</option>
                      <option value="ar-KW">ar-KW (ุงููููุช)</option>
                    </select>
                  </div>

                  <div class="control-section">
                    <div class="section-header">
                      <div class="section-title"><span class="section-icon">โฉ</span> ุงูุณุฑุนุฉ (Rate): <span id="rateV" class="badge"><strong class="mono">1.0</strong></span></div>
                      <div class="section-subtitle">0.6 ุจุทูุก โ 1.4 ุณุฑูุน</div>
                    </div>
                    <input id="rate" type="range" min="0.6" max="1.4" value="1.0" step="0.1" />
                  </div>

                  <div class="control-section">
                    <div class="section-header">
                      <div class="section-title"><span class="section-icon">๐ผ</span> ุงูุญุฏูุฉ (Pitch): <span id="pitchV" class="badge"><strong class="mono">1.0</strong></span></div>
                      <div class="section-subtitle">0 ููุฎูุถ โ 2 ูุฑุชูุน</div>
                    </div>
                    <input id="pitch" type="range" min="0" max="2" value="1.0" step="0.1" />
                  </div>

                  <div class="control-section">
                    <div class="section-header">
                      <div class="section-title"><span class="section-icon">๐</span> ุงูุตูุช (Volume): <span id="volV" class="badge"><strong class="mono">1.0</strong></span></div>
                      <div class="section-subtitle">0 ุตุงูุช โ 1 ูุงูู</div>
                    </div>
                    <input id="volume" type="range" min="0" max="1" value="1.0" step="0.05" />
                  </div>
                </div>

                <div class="button-row" style="margin-top:10px;">
                  <button id="speak" class="primary"><span class="btn-icon">โถ๏ธ</span> ุงูุทู</button>
                  <button id="stop" class="secondary"><span class="btn-icon">โน๏ธ</span> ุฅููุงู</button>
                  <button id="listen" class="secondary"><span class="btn-icon">๐๏ธ</span> ุงุณุชูุน</button>
                  <button id="clear" class="secondary small"><span class="btn-icon">๐งน</span> ูุณุญ</button>
                </div>

                <div class="hint" style="margin-top:8px;">
                  <div class="hint-title">ูุตูุญุฉ</div>
                  <div>ุฅุฐุง ูู ูุนูู ุงููููุฑูููู: ุงุณุชุฎุฏู <span class="mono">localhost</span> ุฃู <span class="mono">https</span>.</div>
                </div>
              </div>
            </div>

            <div class="col-right">
              <div class="card log-card">
                <div class="card-header">
                  <div>
                    <div class="card-title"><span class="icon">๐</span> ุงูุญุงูุฉ</div>
                    <div class="card-subtitle">ูุคุดุฑุงุช ุณุฑูุนุฉ ููุชุดุบูู</div>
                  </div>
                  <span class="badge"><strong>Web Speech</strong> API</span>
                </div>

                <div class="log" id="miniLog" aria-live="polite">
                  <div class="log-line info">โข ูุฐุง ุงูุชุทุจูู ูุนูู ุจุงููุงูู ุฏุงุฎู ุงููุชุตูุญ.</div>
                  <div class="log-line info">โข ุงุฎุชุฑ ุตูุชุงู ููุงุณุจุงู ุซู ุงุถุบุท "ุงูุทู".</div>
                  <div class="log-line info">โข ุงุถุบุท "ุงุณุชูุน" ูุฅููุงุก ุงูููุงู ุฅูู ุงููุต.</div>
                </div>

                <div class="log-footer">
                  <span class="mono">TTS / STT</span>
                  <span class="mono">v1</span>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
(() => {
  // ----- UI refs -----
  const $ = (id) => document.getElementById(id);
  const textEl = $("text");
  const voiceEl = $("voice");
  const dialectEl = $("dialect");
  const speakBtn = $("speak");
  const stopBtn = $("stop");
  const listenBtn = $("listen");
  const clearBtn = $("clear");
  const ttsStatus = $("ttsStatus");
  const sttStatus = $("sttStatus");

  const rateEl = $("rate"), pitchEl = $("pitch"), volumeEl = $("volume");
  const rateV = $("rateV"), pitchV = $("pitchV"), volV = $("volV");
  const syncRanges = () => {
    rateV.textContent = Number(rateEl.value).toFixed(1);
    pitchV.textContent = Number(pitchEl.value).toFixed(1);
    volV.textContent = Number(volumeEl.value).toFixed(2);
  };
  [rateEl, pitchEl, volumeEl].forEach(el => el.addEventListener("input", syncRanges));
  syncRanges();

  // ----- Speech Synthesis (TTS) -----
  const hasTTS = "speechSynthesis" in window && "SpeechSynthesisUtterance" in window;
  let voices = [];

  function populateVoices() {
    if (!hasTTS) {
      ttsStatus.textContent = "ุบูุฑ ูุฏุนูู";
      voiceEl.innerHTML = `<option>ุงููุชุตูุญ ูุง ูุฏุนู ุงููุทู</option>`;
      voiceEl.disabled = true;
      speakBtn.disabled = true;
      stopBtn.disabled = true;
      return;
    }

    voices = speechSynthesis.getVoices() || [];
    // Prefer Arabic voices first
    const arabic = voices.filter(v => (v.lang || "").toLowerCase().startsWith("ar"));
    const others = voices.filter(v => !(v.lang || "").toLowerCase().startsWith("ar"));

    const ordered = [...arabic, ...others];
    voiceEl.innerHTML = ordered.map((v, idx) => {
      const tag = (v.lang || "unknown");
      return `<option value="${idx}">${v.name} โ ${tag}</option>`;
    }).join("");

    // Auto-select first Arabic voice if available
    if (arabic.length > 0) {
      const firstArabicIndex = ordered.indexOf(arabic[0]);
      voiceEl.value = String(firstArabicIndex);
      ttsStatus.textContent = "ุฌุงูุฒ (ุตูุช ุนุฑุจู ูุชููุฑ)";
    } else {
      ttsStatus.textContent = "ุฌุงูุฒ (ูุง ููุฌุฏ ุตูุช ุนุฑุจูโุณููุณุชุฎุฏู ุฃูุฑุจ ุตูุช ูุชุงุญ)";
    }
  }

  // Some browsers load voices async
  if (hasTTS) {
    populateVoices();
    speechSynthesis.onvoiceschanged = populateVoices;
  }

  function speakArabic() {
    if (!hasTTS) return;
    const text = (textEl.value || "").trim();
    if (!text) return;

    // Stop anything currently speaking
    speechSynthesis.cancel();

    const u = new SpeechSynthesisUtterance(text);
    // Try to set Arabic; voice choice matters most.
    u.lang = "ar";

    const idx = Number(voiceEl.value);
    const all = voices.length ? voices : speechSynthesis.getVoices();
    if (all && all[idx]) u.voice = all[idx];

    u.rate = Number(rateEl.value);
    u.pitch = Number(pitchEl.value);
    u.volume = Number(volumeEl.value);

    u.onstart = () => (ttsStatus.textContent = "ูุชููู ุงูุขูโฆ");
    u.onend = () => (ttsStatus.textContent = "ุฌุงูุฒ");
    u.onerror = () => (ttsStatus.textContent = "ุฎุทุฃ ูู ุงููุทู");

    speechSynthesis.speak(u);
  }

  function stopSpeaking() {
    if (!hasTTS) return;
    speechSynthesis.cancel();
    ttsStatus.textContent = "ููููู";
    setTimeout(() => (ttsStatus.textContent = "ุฌุงูุฒ"), 300);
  }

  speakBtn.addEventListener("click", speakArabic);
  stopBtn.addEventListener("click", stopSpeaking);

  // ----- Speech Recognition (STT) -----
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const hasSTT = !!SpeechRecognition;
  let rec = null;
  let listening = false;

  function setupSTT() {
    if (!hasSTT) {
      listenBtn.disabled = true;
      sttStatus.textContent = "ุบูุฑ ูุฏุนูู";
      return;
    }
    rec = new SpeechRecognition();
    rec.continuous = true;
    rec.interimResults = true;

    rec.onstart = () => {
      listening = true;
      sttStatus.textContent = "ูุณุชูุนโฆ";
      listenBtn.textContent = "๐ ุฅููุงู ุงูุงุณุชูุงุน";
    };

    rec.onend = () => {
      listening = false;
      sttStatus.textContent = "ุบูุฑ ูุดุท";
      listenBtn.textContent = "๐๏ธ ุงุณุชูุน (ุชุญููู ููุงูู ุฅูู ูุต)";
    };

    rec.onerror = (e) => {
      sttStatus.textContent = "ุฎุทุฃ: " + (e.error || "unknown");
    };

    rec.onresult = (event) => {
      // Build final + interim
      let finalText = "";
      let interimText = "";
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const res = event.results[i];
        const transcript = res[0].transcript;
        if (res.isFinal) finalText += transcript;
        else interimText += transcript;
      }

      // Put results into the textarea
      // If final text arrives, append it. Show interim at the end.
      const base = textEl.dataset.baseText ?? textEl.value;
      if (finalText) {
        const newBase = (base + (base.trim() ? "\n" : "") + finalText).trim();
        textEl.value = newBase;
        textEl.dataset.baseText = newBase;
      }
      if (interimText) {
        const stable = textEl.dataset.baseText ?? "";
        textEl.value = stable + "\n" + interimText;
      }
    };
  }

  setupSTT();

  function toggleListen() {
    if (!hasSTT || !rec) return;
    if (!listening) {
      // reset base buffer
      textEl.dataset.baseText = textEl.value.trim();
      rec.lang = dialectEl.value;  // e.g., ar-SA
      try { rec.start(); } catch (_) {}
    } else {
      rec.stop();
    }
  }

  listenBtn.addEventListener("click", toggleListen);

  clearBtn.addEventListener("click", () => {
    textEl.value = "";
    textEl.dataset.baseText = "";
    textEl.focus();
  });
})();
  </script>
</body>
</html>
